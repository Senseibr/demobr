---
- hosts: all
  remote_user: centos

  vars:
    # Timezone
    timezone: 'Europe/Paris'

  tasks:
    
    ###################
    # Time management
    ###################
    - name: Set local timezone
      copy: content={{ timezone }}
            dest=/etc/timezone
      notify: update tzdata

    - name: Install NTP (and update apt cache for the first install)
      apt: name=ntp state=present
           update_cache=yes

    - name: Start the ntp service
      service: name=ntp state=started enabled=true

    ###################
    # Security
    ###################
    - name: Install fail2ban
      apt: name=fail2ban state=present

    - name: Start fail2ban service
      service: name=fail2ban state=started enabled=true

    - name: Copy iptables rules
      copy: src=files/iptables.up
            dest=/etc/iptables.up
      notify: reload iptables

    - name: Copy iptables init script # To load iptables on server restart
      copy: src=files/iptables-script
            dest=/etc/network/if-pre-up.d/iptables
            mode=0755

    ###################
    # Misc. tools
    ###################
    - name: Install usefull system tools
      apt: name={{ item }} state=present
      with_items:
        - vim
        - htop
        - git
        - tig
        - ncdu

    ###################
    # Nginx
    ###################
    - name: Install Nginx
      apt: name=nginx state=latest

    - name: Start nginx service
      service: name=nginx state=started enabled=true

    - name: Remove default site config
      file: path=/etc/nginx/sites-enabled/default
            state=absent

    ###################
    # Python / Virtualenv
    ###################
    - name: Install pip
      apt: name=python-pip state=latest

    - name: Install virtualenv
      pip: name=virtualenv

